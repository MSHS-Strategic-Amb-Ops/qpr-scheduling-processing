---
title: "qpr-scheduling-processing"
author: "Riya"
date: "2024-08-06"
output: html_document
---

```{r setup, include=FALSE}

library(glue)
library(odbc)
library(tidyverse)
library(DBI)
library(pool)


##creating dept address long lat table

zipcode_drop <- glue("DROP TABLE DEPARTMENT_LONG_LAT")
zipcode_query <- glue("CREATE TABLE DEPARTMENT_LONG_LAT AS
SELECT a.*, b.LATITUDE, b.LONGITUDE
FROM
(SELECT * FROM DEV_V_DEPARTMENT_ADDRESS) a
LEFT JOIN
(SELECT * FROM DEPT_ZIP_CODE) b
ON a.DEPARTMENT_NAME = b.DEPARTMENT_NAME;")

zipcode_index <- glue("CREATE index zipcode_index on DEPARTMENT_LONG_LAT (DEPARTMENT_ID)")


## creating qpr scheduling processed table

qpr_scheduling_drop <- glue("DROP TABLE PROD_QPR_SCHEDULING")

qpr_scheduling_query <- glue("
CREATE TABLE PROD_QPR_SCHEDULING AS
SELECT k.*, l.TYPE, l.CATEGORY,
CASE WHEN k.DEPT_MANAGED_PROV_MAP IS NOT NULL THEN k.DEPT_MANAGED_PROV_MAP
    WHEN k.DEPT_MANAGED_PROV_MAP IS NULL AND k.DEPT_MANAGED_DEPT_MAP IS NOT NULL THEN k.DEPT_MANAGED_DEPT_MAP
    ELSE k.DEPT_MANAGED_DEPT_MAP 
END AS DEPT_MANAGED_FINAL,
CASE WHEN k.SITE_PROV_MAP IS NOT NULL THEN k.SITE_PROV_MAP
    WHEN k.SITE_PROV_MAP IS NULL AND k.SITE_DEPT_MAP IS NOT NULL THEN k.SITE_DEPT_MAP
    WHEN k.SITE_PROV_MAP IS NULL AND k.SITE_DEPT_MAP IS NULL THEN k.SITE
    ELSE k.SITE
END AS SITE_FINAL,
CASE WHEN k.OFFICE_PROCEDURE_APPT_MAP IS NOT NULL THEN k.OFFICE_PROCEDURE_APPT_MAP
    WHEN k.OFFICE_PROCEDURE_APPT_MAP IS NULL AND k.OFFICE_PROCEDURE_PROV_MAP IS NOT NULL THEN k.OFFICE_PROCEDURE_PROV_MAP
    WHEN k.OFFICE_PROCEDURE_APPT_MAP IS NULL AND k.OFFICE_PROCEDURE_PROV_MAP IS NULL AND k.OFFICE_PROCEDURE_DEPT_MAP IS NOT NULL THEN k.OFFICE_PROCEDURE_DEPT_MAP
    ELSE k.OFFICE_PROCEDURE_DEPT_MAP
END AS OFFICE_PROCEDURE_FINAL,
CASE WHEN k.CLINICAL_DEPT_PROV_MAP_ORG IS NOT NULL THEN k.CLINICAL_DEPT_PROV_MAP_ORG
    WHEN k.CLINICAL_DEPT_PROV_MAP_ORG IS NULL AND k.CLINICAL_DEPT_DEPT_MAP_ORG IS NOT NULL THEN k.CLINICAL_DEPT_DEPT_MAP_ORG
    ELSE k.CLINICAL_DEPT_DEPT_MAP_ORG
END AS CLINICAL_DEPT_DEPT_MAP,
CASE WHEN k.CLINICAL_SUB_DEPT_PROV_MAP_ORG IS NOT NULL THEN k.CLINICAL_SUB_DEPT_PROV_MAP_ORG 
    WHEN k.CLINICAL_SUB_DEPT_PROV_MAP_ORG IS NULL AND k.CLINICAL_SUB_DEPT_DEPT_MAP_ORG IS NOT NULL THEN k.CLINICAL_SUB_DEPT_DEPT_MAP_ORG
    ELSE k.CLINICAL_SUB_DEPT_DEPT_MAP_ORG
END AS CLINICAL_SUB_DEPT_DEPT_MAP,
TRUNC(SYSDATE) AS LAST_UPDATED
FROM
(
    SELECT g.*, h.OFFICE_PROCEDURE_APPT_MAP
    FROM
    (
        SELECT e.*, f.DEPT_MANAGED_PROV_MAP, f.SITE_PROV_MAP, f.OFFICE_PROCEDURE_PROV_MAP, 
        f.CLINICAL_DEPT_PROV_MAP_ORG, f.CLINICAL_SUB_DEPT_PROV_MAP_ORG
        FROM
        (
            SELECT c.*, d.CLINICAL_DEPT_DEPT_MAP_ORG, d.CLINICAL_SUB_DEPT_DEPT_MAP_ORG, 
            d.DEPT_MANAGED_DEPT_MAP, d.OFFICE_PROCEDURE_DEPT_MAP, d.SITE_DEPT_MAP
            FROM
            (
                SELECT a.*, b.ADDRESS_CITY, b.ADDRESS_COUNTY, b.ADDRESS_LINE_1, b.ADDRESS_LINE_2, 
                b.ADDRESS_LINE_3, b.CLEAN_ADDRESS_ZIP_CODE, b.STATE, b.LATITUDE, b.LONGITUDE
                FROM
                (
                    SELECT APPT_DTTM, APPT_MADE_DTTM, CONTACT_DATE, SITE, DEPARTMENT_ID, DEPARTMENT_NAME, 
                    DEPT_SPECIALTY_NAME, NPI, PROV_NAME_WID, PRC_NAME, PAT_ENC_CSN_ID, VISIT_GROUP_NUM, VISIT_METHOD,
                    DERIVED_STATUS_DESC, FINCLASS, VISITPLAN, VISITPAYOR, 
                    ENC_CLOSED_CHARGE_STATUS, Y_ENC_CLOSE_TIME, DEP_RPT_GRP_SEVENTEEN,
                    LOS_NAME, LOS_CODE, ADD_LINE_1 AS PAT_ADD_LINE_1, ADD_LINE_2 AS PAT_ADD_LINE_2,
                    CITY AS PAT_CITY, COUNTY AS PAT_COUNTY, STATE AS PAT_STATE, 
                    CASE WHEN INSTR(ZIP_CODE, '-') > 0 THEN SUBSTR(ZIP_CODE, 1, INSTR(ZIP_CODE, '-') - 1)
                    ELSE ZIP_CODE
                    END AS PAT_CLEANED_ZIP_CODE
                    FROM MV_DM_PATIENT_ACCESS
                    WHERE EXTRACT(YEAR FROM APPT_DTTM) >= 2021
                ) a
                    LEFT JOIN 
                    (SELECT * FROM DEPARTMENT_LONG_LAT) b
                    ON a.DEPARTMENT_ID = b.DEPARTMENT_ID
            ) c
            LEFT JOIN
            (SELECT * FROM MASTER_AMB_MAPPING) d
            ON c.DEPARTMENT_ID = d.DEPARTMENT_ID
        ) e
        LEFT JOIN 
        (SELECT * FROM MASTER_AMB_MAPPING_PROV) f
        ON e.DEPARTMENT_ID = f.DEPARTMENT_ID AND e.NPI = f.NPI
    ) g
    LEFT JOIN
    (SELECT * FROM MASTER_AMB_MAPPING_APPT) h
    ON g.CLINICAL_DEPT_DEPT_MAP_ORG = h.CLINICAL_DEPT_APPT_MAP_ORG AND g.PRC_NAME = h.PRC_NAME
) k
LEFT JOIN 
(SELECT * FROM DEV_EM_CPT_CODE) l
ON k.LOS_CODE = l.CPT_CODE; 
")


qpr_scheduling_index <- glue("CREATE index qpr_scheduling_index on PROD_QPR_SCHEDULING (DEPARTMENT_ID, CAMPUS)")

## Grouped Table execution
tryCatch({
  conn1 <- dbConnect(drv = odbc(), "OAO Cloud DB SoYoun", timeout = 30)
  dbBegin(conn1)
  if(dbExistsTable(conn1, "DEPARTMENT_LONG_LAT")){
  dbExecute(conn1, zipcode_drop) 
  }
  dbExecute(conn1, zipcode_query) 
  dbExecute(conn1, zipcode_index)
  if(dbExistsTable(conn1, "PROD_QPR_SCHEDULING")){
  dbExecute(conn1, qpr_scheduling_drop) 
  }
  dbExecute(conn1, qpr_scheduling_query) 
  dbExecute(conn1, qpr_scheduling_index)
  
  dbCommit(conn1)
  dbDisconnect(conn1)
  print("success")
  
},
error = function(err){
  print(paste("Error staging:", err$message))
  dbRollback(conn1)
  dbDisconnect(conn1)
})

```
